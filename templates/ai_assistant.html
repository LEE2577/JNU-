{% extends "base.html" %}

{% block title %}AI åŠ©æ‰‹ - JNUæ™ºæ…§åº·å…»å¹³å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai_assistant.css') }}">
<style>
    .chat-container {
        max-width: 900px;
        margin: 2rem auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .chat-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .chat-header h1 {
        font-size: 1.8rem;
        color: #2D8CFF;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
    }

    .chat-box {
        height: 480px;
        overflow-y: auto;
        padding: 1rem;
        border-radius: 12px;
        background: #f7f9fb;
        border: 1px solid #e1e4e8;
        margin-bottom: 1.5rem;
        scroll-behavior: smooth;
    }

    .message {
        max-width: 75%;
        padding: 0.8rem 1rem;
        margin-bottom: 1rem;
        border-radius: 12px;
        line-height: 1.5;
        font-size: 1rem;
        animation: fadeIn 0.3s ease-in-out;
        white-space: pre-wrap;
    }

    .user-message {
        background: #2D8CFF;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }

    .bot-message {
        background: white;
        border: 1px solid #dfe2e5;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .chat-input-area {
        display: flex;
        gap: 1rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.9rem 1rem;
        border-radius: 12px;
        border: 1px solid #ccc;
        font-size: 1rem;
    }

    .send-btn {
        background: #2D8CFF;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 0 1.5rem;
        cursor: pointer;
        transition: 0.3s;
    }

    .send-btn:hover {
        background: #1a7ae8;
    }

    .loading {
        display: inline-block;
        width: 7px;
        height: 7px;
        margin-left: 4px;
        background: #2D8CFF;
        border-radius: 50%;
        animation: loadingDots 1s infinite ease-in-out both;
    }

    @keyframes loadingDots {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar">
    <a href="{{ url_for('dashboard') }}" class="nav-brand">
        <i class="fas fa-heartbeat"></i>
        JNUæ™ºæ…§åº·å…»å¹³å°
    </a>
    <div class="nav-links">
        <a href="{{ url_for('dashboard') }}" class="nav-link">ä¸»ç•Œé¢</a>
        <a href="{{ url_for('profile') }}" class="nav-link">ä¸ªäººèµ„æ–™</a>
        <a href="{{ url_for('logout') }}" class="nav-link">é€€å‡ºç™»å½•</a>
    </div>
</nav>

<div class="chat-container">
    <div class="chat-header">
        <h1><i class="fas fa-robot"></i> AI å¥åº·åŠ©æ‰‹</h1>
        <p style="color: #666;">éšæ—¶å‘æˆ‘æé—®ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºæ‚¨æä¾›å¸®åŠ©</p>
    </div>

    <div id="chatBox" class="chat-box">
        <div class="bot-message message">
            æ‚¨å¥½ï¼Œæˆ‘æ˜¯ JNU æ™ºæ…§åº·å…»å¹³å°çš„ AI åŠ©æ‰‹ ğŸ˜Š  
            æˆ‘å¯ä»¥å¸®æ‚¨è§£é‡Šå¥åº·çŸ¥è¯†ã€ç”Ÿæ´»å»ºè®®ã€å¹³å°æ“ä½œæŒ‡å¼•ç­‰å†…å®¹ã€‚
        </div>
    </div>

    <div class="chat-input-area">
        <input type="text" id="userInput" class="chat-input" placeholder="è¯·è¾“å…¥å†…å®¹..." onkeydown="if(event.key==='Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sendMessage() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if (!text) return;

    appendMessage(text, "user");
    input.value = "";

    // æ˜¾ç¤ºæ­£åœ¨æ€è€ƒ
    appendMessage("æ­£åœ¨æ€è€ƒä¸­ <span class='loading'></span>", "bot", true);

    fetch("/assistant/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    })
    .then(r => r.json())
    .then(data => {
        removeLoadingMessage();

        if (data.reply) {
            appendMessage(data.reply, "bot");
        } else {
            appendMessage("æŠ±æ­‰ï¼ŒAI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚", "bot");
        }
    })
    .catch(err => {
        removeLoadingMessage();
        appendMessage("å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚", "bot");
    });
}

function appendMessage(text, sender, isLoading = false) {
    const box = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = sender === "user" ? "message user-message" : "message bot-message";
    msg.innerHTML = text;
    if (isLoading) msg.classList.add("loading-msg");
    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;
}

function removeLoadingMessage() {
    const loadingMsg = document.querySelector(".loading-msg");
    if (loadingMsg) loadingMsg.remove();
}
</script>
{% endblock %}
